### 13.1 自动化测试（关键断言）
- `GradSessionAndRateLimitTests`
  - 会话初始化：`POST /api/grad/session/init` 返回 `userId`、`sessionId`。
  - 会话级限流：第 4 次请求命中 429，响应头包含 `Retry-After`（由 `grad.recommend.rate-limit-retry-after-seconds` 指定）。
  - IP 级限流：无 `X-Session-Id` 时按 IP 计数，同样断言 429 + `Retry-After`。
- `GradSessionCleanupTests`
  - `deleteOlderThan(now-7d)` 仅删除过期会话（`last_seen` 超过 7 天），保留近期开启的会话。

# 子模块：研究生择导模块（后端）

## 1. 需求范围（当前阶段）
- 学生侧
  - 录入/更新“学生画像”：学校/专业、GPA、英语、竞赛/科研经历、研究方向偏好、地区偏好、导师风格偏好、目标院校层级
  - 支持“目标具体专业/方向 Top-N”（建议：方向Top-N + 权重），便于更细粒度匹配
  - 获取导师推荐列表（按研究方向、学校、头衔、地区等筛选与排序）
  - 查看导师详情（方向、近年论文、招生名额、标签）
  - 管理志愿清单（多志愿 + 优先级）
- 导师侧（后续阶段）
  - 维护导师信息、方向、名额、论文/项目
- 推荐与评分
  - 基于学生画像与导师标签计算匹配度：方向相似度、层级门槛、偏好加权
  - 输出 status ∈ {fit, borderline, unfit} 与 reasons 列表
- 数据范围
  - 现阶段仅“一（东南大学）对多（导师）”；数据先用种子数据，后续替换真实数据

## 2. 业务流程（V1）
1) 学生填写/更新画像
2) 系统根据画像与导师库计算匹配度（方向匹配、门槛过滤、偏好加权）
3) 返回导师推荐列表（分页/筛选/排序）
4) 学生查看导师详情
5) 学生加入志愿清单并设置优先级

异常路径：画像不完整/门槛不达标 => 返回 status: unfit 与原因

## 3. 关于“目标具体专业/方向 Top-N”的建议
- 建议加入 Top-N 方向清单并支持权重，便于更细化匹配与排序。
- 字段设计：`target_directions_topn` 使用 JSON 数组，元素形如：
  ```json
  [
    { "directionId": 101, "weight": 1.0 },
    { "directionId": 102, "weight": 0.7 },
    { "directionId": 103, "weight": 0.5 }
  ]
  ```
- 匹配逻辑：方向相似度以 Top-N 权重为系数叠加，提升最关注方向的匹配分。

## 4. 数据库表（新增，MySQL，无外键，索引为主）
- 字典类
  - `grad_research_direction(id, name, parent_id, created_at, updated_at)`
  - `grad_department(id, university_id, name, created_at, updated_at)`
- 导师与画像
  - `grad_mentor(id, university_id, department_id, name, title, email, homepage, brief, created_at, updated_at)`
  - `grad_mentor_direction(mentor_id, direction_id)`（多对多，唯一索引）
  - `grad_mentor_quota(id, mentor_id, year, total_slots, filled_slots, notes)`（唯一索引 (mentor_id, year)）
  - `grad_mentor_tag(id, name)`；`grad_mentor_tag_map(mentor_id, tag_id)`
  - `grad_mentor_publication(id, mentor_id, title, venue, year, link)`
  - `grad_student_profile(id, user_id, current_university, current_major, gpa, english_score, competitions, research_exp, preferred_directions JSON, region_pref, style_pref, target_tier, target_universities JSON, target_directions_topn JSON, updated_at)`
  - `grad_student_preference(id, student_id, mentor_id, priority, notes, created_at, updated_at)`
- 匹配与日志
  - `grad_mentor_student_fit(id, student_id, mentor_id, score, status, reasons JSON, computed_at)`

索引建议（节选）：
- `grad_mentor(university_id, department_id)`
- `grad_mentor_direction(direction_id)`
- `grad_mentor_tag_map(tag_id)`
- `grad_mentor_student_fit(student_id, score desc)`

## 5. 评分模型（V1）
- 方向匹配：exact 命中 1.0，父子方向近邻 0.7，远邻 0.4（可调）；叠加 Top-N 权重
- 门槛过滤：GPA/英语阈值、目标层级与导师/学校层级
- 偏好加权：地区、风格、标签
- 产出：`score ∈ [0,100]`，`status ∈ {fit, borderline, unfit}`，`reasons`（JSON数组）

## 6. 接口草案（REST）
- 学生画像
  - POST `/api/grad/profile` 保存/更新画像
  - GET `/api/grad/profile` 获取画像
- 导师检索
  - GET `/api/grad/mentors?universityId=&directionId=&region=&title=&keyword=&page=&size=`
  - GET `/api/grad/mentors/{mentorId}` 详情（方向、论文、名额、标签）
- 推荐与匹配
  - POST `/api/grad/recommend` 触发计算（可带阈值/权重 overrides）
  - GET `/api/grad/recommend?page=&size=` 查看推荐结果
- 志愿清单
  - POST `/api/grad/preferences` {mentorId, priority, notes}
  - GET `/api/grad/preferences`
  - DELETE `/api/grad/preferences/{id}`
- 字典
  - GET `/api/grad/dicts/directions?parentId=`

统一返回：
- 成功：`{ code: 0, data: ..., message: "ok" }`
- 业务异常：`{ code: 400xx, status: "unfit", message: "原因", details: [...] }`
- 系统异常：`{ code: 500xx, message: "internal error" }`

## 7. 测试用例清单（curl/JUnit）
- 正常：
  - 完整画像 -> 推荐列表按 `score` 降序
  - 导师检索（学校/方向/标题）
  - 志愿添加/更新/删除
- 边界：
  - 无方向但有关键词
  - 画像缺字段 -> 明确缺失项
  - 名额已满导师
- 异常：
  - 非法参数（负页码/过大 size）
  - mentorId 不存在
  - 志愿唯一性与幂等

## 8. 进度与后续
- 本次输出：文档 + 表结构 + 种子数据（东南大学）
- 后续：实现后端实体/仓库/服务/控制器 + JUnit + curl 脚本；对接真实数据源（论文/项目等量化指标）

## 9. 无外键运维与数据治理约定（重要）
为满足“数据库不添加外键”的要求，本模块采用“应用层约束 + 索引 + 测试保证”的一致性策略：

- 完整性保障（服务层）
  - 创建/更新：在写入前校验关联实体是否存在（如 `mentor_id`、`direction_id`、`student_id`）。
  - 删除保护：删除导师/方向/学生前，检查引用表（志愿、匹配结果、方向映射、名额、标签映射、论文）。如存在引用，返回业务错误码并提示处理顺序。
  - 并发与幂等：通过唯一索引控制（如 `grad_mentor_direction(mentor_id,direction_id)`、`grad_student_preference(student_id,mentor_id)`、`grad_mentor_quota(mentor_id,year)`）。

- 数据库层策略
  - 不使用外键约束；只使用必需的索引与唯一索引。
  - 启动初始化：`schema.sql` 在创建研究生模块表之前执行 `DROP TABLE IF EXISTS ...`，便于开发与测试环境反复初始化。

- 清理流程（示例建议）
  1) 清理引用数据：`grad_student_preference`、`grad_mentor_student_fit`、`grad_mentor_publication`、`grad_mentor_tag_map`、`grad_mentor_quota`、`grad_mentor_direction`。
  2) 再删除主体：`grad_mentor`、`grad_research_direction`、`grad_department` 等。
  3) 提供批量清理脚本与后台管理接口（后续阶段）。

- 测试覆盖
  - 删除前引用检查：尝试删除仍被引用的导师，应返回业务错误（不落库）。
  - 重复插入唯一键冲突：验证唯一索引生效并返回明确错误。
  - 并发提交：在服务层加事务与乐观处理，验证不产生脏数据。

## 10. 流程图（Mermaid）
```mermaid
flowchart TD
  A[学生提交/更新画像 POST /api/grad/profile] --> B{画像是否完整}
  B -- 否 --> B1[返回错误/缺失字段]
  B -- 是 --> C[查询导师/方向/标签/名额]
  C --> D[计算匹配度: Top-N 方向 + 近邻 + 标签 + 名额]
  D --> E[生成推荐结果]
  E --> F[GET/POST /api/grad/recommend]
  F --> G[学生查看详情/加入志愿(后续阶段)]
```

## 11. 接口关系图（Mermaid）
```mermaid
graph LR
  subgraph Dict
    D1[/GET /api/grad/dicts/directions/]
  end
  subgraph Profile
    P1[/POST /api/grad/profile/]
    P2[/GET /api/grad/profile/]
  end
  subgraph Mentor
    M1[/GET /api/grad/mentors/]
    M2[/GET /api/grad/mentors/{id}/]
  end
  subgraph Recommend
    R1[/POST /api/grad/recommend/]
    R2[/GET /api/grad/recommend/]
  end
  P1 --> R1
  P2 --> R2
  D1 --> P1
  D1 --> R1
  M1 --> R1
```

## 12. 接口清单与参数（摘要）
- 学生画像
  - POST `/api/grad/profile` Body: ProfileSaveRequest（`userId` 必填，其他可选）
  - GET `/api/grad/profile?userId=`
- 导师检索
  - GET `/api/grad/mentors?universityId=&directionId=&title=&keyword=&page=&size=`
  - GET `/api/grad/mentors/{id}`
- 推荐
  - POST `/api/grad/recommend?userId=&page=&size=`
  - GET `/api/grad/recommend?userId=&page=&size=`
- 字典
  - GET `/api/grad/dicts/directions?parentId=`（若省略 `parentId` 返回全量；`parentId=0` 代表顶层）

## 12.1 推荐引擎策略与可配置项（维护便捷性）
- 硬性门槛（逐项必达）
  - 仅 GPA：只校验 GPA；仅英语类型：只校验类型；仅英语分数：只校验分数；类型+分数都设：两者都必须满足。
  - 任一被要求项不满足/缺失 → 该导师 `status=unfit`，`reasons` 给出具体原因。
- 无方向与缺信息处理
  - 无 Top-N：不再“等权凑分”，使用低基线分（默认 20），强制 `borderline`，`reason=未提供目标方向`。
  - 关键信息缺失（专业/GPA/英语）逐项扣分（默认每项 5），`reasons` 追加 `缺少专业信息/缺少GPA/缺少英语信息`。
- 专业域不匹配惩罚（可配置/表驱动）
  - 学生专业域 vs 导师方向域不一致 → 扣分（默认 30），至少 `borderline`，`reason=专业方向不匹配`。
  - 域识别优先走“表映射”，无表数据时回退到 properties。
- 最小得分门槛（gating）
  - 开启后（默认 true），过滤低于 `minScore`（默认 60）的结果，避免低质量推荐。

当前属性项（位于 `grad/config/GradRecommendProperties.java`，application.yml 可覆盖）
- `top-n` Top-N 上限（默认 3）
- `no-pref-base-score` 无方向时基线分（默认 20）
- `missing-info-penalty` 缺信息扣分（默认 5/项）
- `use-min-score-gate` 是否启用最小分门槛（默认 true）
- `min-score` 最小分门槛（默认 60）
- `insufficient-profile-missing-fields-threshold` 资料不足短路阈值（默认 2，统计：专业/GPA/英语/Top-N）
- `domain-mismatch-penalty` 跨专业惩罚（默认 30）
- `cs-root-ids` 用于回退的 CS 根方向 ID 列表（默认 [101]）
- `major-domain-keywords` 专业域关键字映射（仅在无表映射时作为兜底）

## 12.2 资料不足/无匹配语义（前端对齐）
- 资料不足 `status=unfit`，`code=insufficient_profile`
  - 判定：缺失项计数 ≥ 阈值（默认 2）。缺失项包含：专业/GPA/英语/Top-N。
  - 前端提示：请补充专业/GPA/英语/目标方向后再计算，并引导回画像表单。
- 无匹配 `status=unfit`，`code=no_match`
  - 判定：最小分门槛过滤后无结果或全量不合适。
  - 前端提示：未找到匹配导师，建议完善画像或放宽条件（地域/方向/风格）。

## 12.3 域映射表（表驱动，便于运营）
- 新表（无外键，服务层治理）：
  - `grad_domain(code, name)` 域字典，如 CS/LIT
  - `grad_major_domain_map(id, domain_code, keyword)` 专业关键字到域映射
  - `grad_direction_domain_map(direction_id, domain_code)` 方向到域映射
- 回退策略：若三表无数据，后端回退到 `cs-root-ids` 与 `major-domain-keywords`。
- 初始化数据（示例 SQL 片段，可加入 `data.sql`）：
```sql
-- 域字典
INSERT INTO grad_domain(code, name) VALUES ('CS','计算机'),('LIT','文学')
  ON DUPLICATE KEY UPDATE name=VALUES(name);

-- 专业关键字
INSERT INTO grad_major_domain_map(domain_code, keyword) VALUES
 ('CS','计算机'),('CS','软件'),('CS','人工智能'),('CS','软件工程'),('CS','cs'),
 ('LIT','汉语言'),('LIT','中文'),('LIT','文学');

-- 方向映射（示例：101=计算机科学为CS域根；可按需覆盖子方向）
INSERT INTO grad_direction_domain_map(direction_id, domain_code) VALUES (101,'CS')
  ON DUPLICATE KEY UPDATE domain_code=VALUES(domain_code);
```

## 12.4 前端渲染规范（摘要）
- 接口返回 `status=unfit` 且 `code=insufficient_profile/no_match` 时，顶部黄条提示，并引导补齐画像或放宽条件。
- 普通结果的 `reasons` 以标签/tooltip 展示（如：GPA不足/英语不足/名额已满/专业方向不匹配/未提供目标方向/缺少GPA 等）。
- 推荐优先级：按 `score` 降序。前端无需本地排序。

## 12.5 策略模块化（Maintainability & Evolution）
为提升可维护性与可扩展性，推荐引擎已重构为“策略流水线”。`GradRecommendServiceImpl` 负责：数据装载 → 组装 `PolicyContext` → 依序执行策略 → 汇总 `RecommendResultDTO`。

- 执行顺序（保持与旧版完全一致）：
  1) ThresholdPolicy（导师硬性门槛逐项必达）
  2) DirectionProximityPolicy（方向近邻：exact=1.0，父子=0.7，兄弟=0.5；无 Top-N → 低基线 + borderline）
  3) TagBonusPolicy（标签偏好 +5）
  4) QuotaPenaltyPolicy（名额已满 -10 且 borderline）
  5) DomainPenaltyPolicy（表优先、配置兜底，跨域扣 `domainMismatchPenalty` 且至少 borderline）
  6) MissingInfoPenaltyPolicy（缺少专业/GPA/英语逐项扣 `missingInfoPenalty`）
  7) MinScoreGatePolicy（保留策略类，实际过滤在聚合阶段执行，行为不变）

- 关键类：
  - `policy/RecommendPolicy` 策略接口
  - `policy/PolicyContext` 策略上下文（画像、导师、方向、标签、名额、缓存、配置等）
  - `policy/ScoreAccumulator` 累加器（score/status/reasons 聚合与封顶）

- 缓存与刷新
  - `DictCacheService` 启动期缓存方向树/域映射/专业关键字映射，供策略使用
  - 变更后端表数据后，可调用 `POST /api/grad/dicts/refresh` 刷新缓存，秒级生效

- 回滚策略
  - 策略为“可插拔”。若需快速回滚某项策略，保留策略顺序不变，临时改为 no-op 即可（或调整阈值使其不生效）。

## 12.6 会话初始化与限流（前端须按本文约定联调）
- 接口：会话初始化
  - Method: POST
  - URL: `/api/grad/session/init`
  - Header: 可空（服务端从 `X-Forwarded-For` 或 `remoteAddr` 取 IP）
  - Response: `{ status:"ok", data: { userId: number, sessionId: string }, traceId }`
  - 说明：前端在页面加载时调用一次，缓存 `userId` 与 `sessionId`。之后所有 `/api/grad/**` 请求在 Header 附加 `X-Session-Id`。

- 限流策略（RateLimitFilter）
  - 保护范围：`/api/grad/**`（不含 `/api/grad/session/init`、`/actuator`、`/static`）
  - 限流维度：优先 Session（`X-Session-Id`），否则按 IP
  - 配置项（application.yml 可覆盖，默认如下）：
    - `grad.recommend.rate-limit-per-session-per-minute: 60`
    - `grad.recommend.rate-limit-per-ip-per-minute: 60`
    - `grad.recommend.rate-limit-retry-after-seconds: 30`
  - 触发限流：HTTP 429，响应体：`{ status:"error", message:"rate_limited", traceId }`
  - 响应头：`Retry-After: <秒数>`（前端可据此做倒计时或禁用按钮）

- 会话清理（定时任务）
  - 任务：`SessionCleanupTask`，每小时执行一次，删除 `last_seen < now - sessionTtlDays` 的会话
  - 配置项：`grad.recommend.session-ttl-days: 7`
  - 影响：只影响匿名会话表 `grad_session`，不影响功能使用。

- 前端联调要点（摘要）
  - 首次进入页面：调用 `/api/grad/session/init` 获取 `userId` 与 `sessionId`
  - 所有 `/api/grad/**` 请求头附带：`X-Session-Id: <sessionId>`
  - 如收到 `429`：读取 `Retry-After` 秒数，提示“请求频繁，请 X 秒后重试”，并在界面做倒计时或禁用按钮
  - “用户ID”字段不再人工输入，使用服务端生成的 `userId`

## 12.7 计算必填项说明（Top-N）
- 自本版起，“Top-N 重点方向”在“计算推荐/获取推荐”时为必填项（保存画像时可为空）。
- 若缺失（含：专业/GPA/英语/Top-N 任一项缺失的总计达到阈值），服务端返回：
  - `status=unfit, code=insufficient_profile`，并在 `reasons` 中提示需要补充的信息。
- 相关配置：`grad.recommend.insufficient-profile-missing-fields-threshold: 1`

## 13. 测试日志（本轮增强）
- 正常用例
  - 保存画像 -> 推荐：成功返回按 score 降序列表；当 `stylePref=友好` 时，含“友好”标签导师分数 +5。
  - 导师列表：分页/关键字检索生效。
  - 字典：`/api/grad/dicts/directions` 返回 SEU 示例方向树。
- 边界用例
  - 分页非法：`size=0` 或 `page=-1`，返回 `status:error`，消息包含校验提示（由全局异常处理器统一输出）。
  - Top-N 为空：回退到 `preferredDirections`；仍为空则使用等权 dummy，避免全 0。
  - 方向近邻：当学生 Top-N 与导师方向为父子/兄弟关系时，得分分别按 0.7/0.5 加权。
- 异常用例
  - Body 解析失败：返回 `status:error`，message=`request_body_invalid`。
  - 画像不存在：`GET /api/grad/profile?userId=X` 未找到时返回 `status:unfit`，reason=`profile_not_found`。

## 14. curl 脚本（片段）
```bash
# 1) 保存画像
curl -X POST "http://localhost:8080/api/grad/profile" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 10001,
    "currentUniversity": "某高校",
    "currentMajor": "软件工程",
    "gpa": 3.6,
    "englishType": "CET6",
    "englishScore": 570,
    "preferredDirections": "[102,103]",
    "regionPref": "华东",
    "stylePref": "友好",
    "targetTier": "985",
    "targetUniversities": "[{\"id\":1,\"name\":\"东南大学\"}]",
    "targetDirectionsTopn": "[{\"directionId\":102,\"weight\":1.0},{\"directionId\":103,\"weight\":0.7}]"
  }'

# 2) 导师列表
curl "http://localhost:8080/api/grad/mentors?universityId=1&page=0&size=20"

# 3) 推荐
curl -X POST "http://localhost:8080/api/grad/recommend?userId=10001&page=0&size=20"

# 4) 方向字典
curl "http://localhost:8080/api/grad/dicts/directions?parentId=101"
