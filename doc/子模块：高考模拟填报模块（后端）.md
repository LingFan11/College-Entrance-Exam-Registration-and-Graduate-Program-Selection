1) 模块目标与范围
- 目标：根据考生省份、科类、分数/位次与偏好，推荐院校-专业志愿（冲/稳/保分层）。
- 范围：后端接口与服务实现；当前仅东南大学（江苏，2024 年）数据，结构可拓展。

2) 流程图（文字版）
```
开始 → 参数校验（省份/科类，rank 或 score 至少一个）
→ 位次解析（score→rank，rank_mapping）
→ 载入数据（university_major_plan + university_major_stat）
→ 偏好过滤（城市/层次/专业关键词/学费上限）
→ 风险分桶（基于 delta = candidateRank - lastYearMinRank）
   - rush（冲）：delta > rushWindow（考生位次比去年最低位次差，需要冲刺）
   - stable（稳）：|delta| <= rushWindow（接近去年最低位次，比较稳）
   - safe（保）：delta < -rushWindow（考生位次远好于去年最低位次，很保险）
   - rushWindow 默认 50，可根据 risk 参数调整：
     - aggressive：rushWindow * 1.5
     - balanced：默认值
     - conservative：rushWindow * 0.5
→ 评分与排序（偏好加权，基础50，位次接近度最高+30，偏好最高+20）
→ 生成响应（status: ok | unfit | error）
```

3) 数据库设计（MySQL，无外键，含索引）
- 表：`university`, `major`, `university_major_plan`, `university_major_stat`, `rank_mapping`
- 索引：
    - plan：`(university_id)`, `(major_id)`, `(province, subject_type, year)`
    - stat：同上 `(university_id)`, `(major_id)`, `(province, subject_type, year)`
- 注意：`rank_mapping.rank_value` 为位次列；DDL 中 `year` 使用反引号定义，实体映射列名为 `year`。

4) 接口文档（MVP）
- 基础路径：`/api/gaokao`

- POST `/recommend`
    - 描述：生成志愿推荐（冲/稳/保）
    - 请求体（JSON）
        - province: string 必填
        - subjectType: string 必填（物理|历史）
        - rank: int 与 score 二选一；当 rank > maskTopRank 必须提供 score（屏蔽规则）
        - score: int 与 rank 二选一（需可映射 rank）；当与 rank 同时提供时会进行赋分制一致性校验
        - year: int 默认 2024
        - preferences: { cities?: string[]; tiers?: string[]; majors?: string[]; tuitionMax?: int }
        - risk: string 可选（aggressive|balanced|conservative），默认 balanced
        - size: int 返回每个分桶最大条数，默认 20
    - 成功响应（节选示例）
```json
{
  "status": "ok",
  "data": {
    "resolvedRank": 4200,
    "rankSource": "band",
    "rankBandMin": 3000,
    "rankBandMax": 4200,
    "scoreUsed": 605,
    "buckets": {
      "rush": [ {"universityName":"东南大学","majorName":"土木工程","lastYearMinRank":8000, "lastYearMinScore":560} ],
      "stable": [ {"universityName":"东南大学","majorName":"软件工程","lastYearMinRank":5000, "lastYearMinScore":580} ],
      "safe": [ {"universityName":"东南大学","majorName":"计算机科学与技术","lastYearMinRank":3500, "lastYearMinScore":610} ]
    },
    "explain": "基于上一年最低位次、最低分数与偏好打分的MVP推荐..."
  },
  "traceId": "..."
}
```
- 不合适（参数/无结果）
```json
{ "status": "unfit", "reason": "暂无符合条件的专业志愿", "traceId": "..." }
```
- 系统异常
```json
{ "status": "error", "message": "系统繁忙，请稍后再试", "traceId": "..." }
```

- GET `/dictionaries`
    - 描述：返回字典（省份/科类/批次/层次/专业大类/城市）
    - 响应：`{ status: "ok", data: { provinces:[], subjectTypes:[], batches:[], tiers:[], majorCategories:[], cities:[] } }`

- GET `/example`
    - 描述：示例请求体
    - 响应：`{ status: "ok", data: { province:"江苏", subjectType:"物理", rank:5000, year:2024, risk:"balanced" } }`

5) curl 测试命令与实际响应（开发环境）
- 字典
```bash
curl -s http://localhost:8080/api/gaokao/dictionaries | jq
```
示例输出（节选）：
```json
{ "status":"ok", "data": { "provinces":["江苏"], "subjectTypes":["history","physics"], "batches":["本科批"], "tiers":["双一流"], "cities":["南京"], "majorCategories":["工学"] } }
```

- 示例请求
```bash
curl -s http://localhost:8080/api/gaokao/example | jq
```

-- 推荐（正常）
```bash
curl -s -H "Content-Type: application/json; charset=utf-8" \
  --data '{"province":"江苏","subjectType":"物理","rank":5000,"year":2024,"risk":"balanced","preferences":{"cities":["南京"],"tiers":["985"],"majors":["计算机","软件"],"tuitionMax":7000},"size":20}' \
  http://localhost:8080/api/gaokao/recommend | jq
```
预期（节选）：rush 包含土木工程，stable 包含软件工程，safe 包含计算机科学与技术。

-- 推荐（学费上限过低）
```bash
curl -s -H "Content-Type: application/json; charset=utf-8" \
  --data '{"province":"江苏","subjectType":"物理","rank":5000,"year":2024,"preferences":{"tuitionMax":1000}}' \
  http://localhost:8080/api/gaokao/recommend | jq
```
预期：`status: unfit`，`reason` 包含“暂无符合条件的专业志愿”。

8) 赋分制一致性校验（rank & score）

- 规则：当同时提供 rank 与 score 时，后端用 `rank_mapping` 映射 score→rank，若与请求 rank 的差值超过 `consistency-tolerance-rank`（默认 300），返回不合适。
- 配置：
  - `gaokao.recommend.consistency-check-enabled: true`
  - `gaokao.recommend.consistency-tolerance-rank: 300`
  - `gaokao.recommend.prefer-input: rank|score`（一致时采用哪个输入）
- 示例（不一致 → unfit）：
```bash
curl -s -H "Content-Type: application/json; charset=utf-8" \
  --data '{"province":"江苏","subjectType":"物理","rank":5000,"score":570,"year":2024}' \
  http://localhost:8080/api/gaokao/recommend | jq
```
预期：
```json
{ "status": "unfit", "reason": "参数不合适：分数与位次不一致（赋分制约束）", "traceId": "..." }
```

9) 分数达线优先（use-min-score-gate）

- 规则：当开启 `gaokao.recommend.use-min-score-gate: true` 时，先按分数达线过滤，再按位次降级判定。
  - 若存在 `min_score` 且请求带 `score`：要求 `score >= min_score + min-score-grace`；否则过滤。
  - 若缺少 `min_score` 或请求缺 `score`：降级为 `rank <= min_rank + rank-grace` 判定。
- 配置：
  - `gaokao.recommend.use-min-score-gate: true`
  - `gaokao.recommend.min-score-grace: 0`
  - `gaokao.recommend.rank-grace: 0`
- 示例（未达线 → 被过滤）：
```bash
curl -s -H "Content-Type: application/json; charset=utf-8" \
  --data '{"province":"江苏","subjectType":"物理","score":600,"year":2024,"preferences":{"majors":["计算机"]}}' \
  http://localhost:8080/api/gaokao/recommend | jq
```
预期：结果中不出现 `计算机科学与技术`（若该专业 2024 `min_score`=610）。

10) 分数→位次 最近邻映射（mapping-nearest-enabled）

- 背景：当 `rank_mapping` 缺少某个精确分数档时，直接报错体验较差；启用最近邻策略可在“允许的分差”内选择最接近的分数档映射位次。
- 规则：
  - 先尝试精确匹配（score 完全一致）；若无，则分别查找“≤score 的最近低档”和“≥score 的最近高档”。
  - 比较两侧“分差”选择最近者；若分差相同，取更保守的更大 rank 值（数值更大）。
  - 若最近分差仍超过阈值 `mapping-max-score-delta`（默认 20 分），则返回不合适（避免过度外推）。
- 配置：
  - `gaokao.recommend.mapping-nearest-enabled: true`
  - `gaokao.recommend.mapping-max-score-delta: 20`
- 示例（同距取保守）：
```bash
curl -s -H "Content-Type: application/json; charset=utf-8" \
  --data '{"province":"江苏","subjectType":"物理","score":600,"year":2024}' \
  http://localhost:8080/api/gaokao/recommend | jq
```
说明：若仅存在 598 分与 602 分两个档位，且二者与 600 分分差同为 2，则取更保守的较大 rank（对应 598 档）。

11) 分数段→位次区间（Band 优先）

- 背景：实际填报以分数为主，使用分数段对应的位次区间更稳健，且对零散分数更友好。
- 规则：
  - 若开启 `use-rank-band-first: true`，则先在 `rank_band` 中按分数定位区间 `[score_min, score_max]`。
  - 命中区间后，按 `band-prefer-conservative` 选择区间位次（默认取更保守的 `rank_max`）。
  - 未命中时再回退到 `rank_mapping`（精确/最近邻）。
- 数据：示例已在 `data.sql` 中为 江苏-物理/历史-2024 写入 3 段样例。
- 配置：
  - `gaokao.recommend.use-rank-band-first: true`
  - `gaokao.recommend.band-prefer-conservative: true`
- curl 示例：
```bash
curl -s -H "Content-Type: application/json; charset=utf-8" \
  --data '{"province":"江苏","subjectType":"物理","score":605,"year":2024}' \
  http://localhost:8080/api/gaokao/recommend | jq
```
说明：命中 600~609 分段，位次区间为 [3000,4200]，默认取保守 4200 参与后续分桶与匹配。

12) 科目选择（首选/次选）与过滤

- 请求体：`firstSubject: string`（物理/历史），`secondSubjects: string[]`（化学/生物/政治/地理，最多2）
- 字典：`firstSubjects`、`secondSubjects` 由 `/dictionaries` 下发（当前为静态常量）
- 过滤（当前软过滤）：
  - 若请求携带 `firstSubject`，则要求与 `plan.subject_type` 一致（物理/历史）；不一致则过滤该志愿
  - `secondSubjects` 暂不强制（数据未建模时放行）；后续将扩展 `university_major_plan` 科目要求字段以支持硬过滤

13) 位次解析元信息（结构化返回）

- 字段说明（位于 `data` 顶层）：
  - `resolvedRank: number` 最终用于分桶/匹配度的位次值
  - `rankSource: string` 位次来源：`band | mapping_exact | mapping_nearest | clamp_high | clamp_low | input_rank | input_rank_checked`
  - `rankBandMin: number | null` 命中 band 时的位次区间下界
  - `rankBandMax: number | null` 命中 band 时的位次区间上界
  - `scoreUsed: number | null` 实际用于映射的分数（采用分数侧时回填）
- 示例：当江苏/物理/2024 分数 605 命中 600~609 分段，位次区间 [3000,4200]，保守取 4200：
```json
{
  "status":"ok",
  "data":{
    "resolvedRank":4200,
    "rankSource":"band",
    "rankBandMin":3000,
    "rankBandMax":4200,
    "scoreUsed":605,
    "buckets":{ /* ... */ }
  },
  "traceId":"..."
}
```

6) 单元测试（JUnit）与结果
- RecommendationServiceImplTest
    - 正常分桶：通过
    - 学费过滤为 1000：抛 BizException → 通过
- RankingServiceImplTest
    - 提供 rank：直接返回 → 通过
    - score 可映射：返回 rank_value → 通过
    - score 不可映射：抛 BizException → 通过
- DictionaryServiceImplTest
    - 字典内容包含：江苏/physics/本科批/双一流/南京/工学 → 通过

7) 进度同步（总文档）
- 高考模拟填报模块（后端）
    - 架构：Service 接口 + Impl；Controller；统一异常；DTO/实体/仓库
    - 数据库：MySQL，无外键，含必要索引；提供 schema.sql 与 data.sql（东南大学数据）
    - 接口：/recommend、/dictionaries、/example
    - 测试：完成核心单元测试，提供 curl 脚本；待补 MockMvc 集成测试
    - 下一步：
        - 增补 MockMvc 控制器测试与更多边界场景
        - 可选：接入 Flyway 管理 DDL 变更；扩充学校与年份数据

八、匹配度算法说明（MVP）

1) 设计目标
- 提供可解释的“匹配度”评分，用于同一分层（冲/稳/保）内的排序
- 便于后续参数化与个性化权重调节

2) 评分公式（0~100）
- 基础分 base = 50
- 位次接近度加分 proximity ∈ [0, 30]
    - candidateRank 与 lastYearMinRank 的绝对差 delta = |candidateRank - lastYearMinRank|
    - 线性衰减：proximity = 30 - min(30, delta / 100)
    - 含义：每相差 100 名，-1 分，最多扣 30 分；越接近去年的最低位次，分数越高
- 偏好加分 preferences ∈ [0, 20]
    - 专业关键词命中 +10（name 或 category 包含任一关键词）
    - 城市命中 +5
    - 层次命中 +5（如：双一流/211/985/普通）
- 最终：fitScore = clamp(base + proximity + preferences, 0, 100)

3) 说明
- 若 lastYearMinRank 缺失则不计算 proximity 加分
- 偏好为空则不加分；不会出现所有项固定 60 的情况
- 后续可将权重与阈值（基础分、每 100 名的扣分、各偏好权重）配置化

4) 验证
- 单测：`RecommendationServiceFitScoreTest` 验证 proximity + 偏好影响分数，确保不同专业得分不同且合理

九、屏蔽规则（当前生效）

1) 规则描述
- 全国统一：前 N 名（默认 N=50）视为“屏蔽”区间。
- 若考生提供 rank 且 rank ≤ 50：无需提供分数（score）。
- 若考生提供 rank 且 rank > 50：必须提供分数（score），否则返回 `status: unfit`。
- 配置位置：`application.yml` → `gaokao.recommend.mask-top-rank` 与 `require-score-beyond-mask`。

2) 处理流程位置
- 由 `RankingServiceImpl.resolveRank(...)` 统一处理。

3) curl 示例（rank=100 未提供分数 → unfit）
```bash
curl -s -H "Content-Type: application/json; charset=utf-8" \
  --data '{"province":"江苏","subjectType":"物理","rank":100,"year":2024}' \
  http://localhost:8080/api/gaokao/recommend | jq
```
预期：
```json
{ "status": "unfit", "reason": "参数不合适：该位次需提供分数用于屏蔽规则校验", "traceId": "..." }
```