# 子模块：学校信息模块（后端）

## 1. 需求范围（当前阶段）
- 用户侧（学生/访客）
  - 按学校检索与查看：基本概况、层级（211/985/双一流等）、所在地、官网链接
  - 学科与专业：强势学科、特色专业、开设学院列表
  - 招生信息：本科/研究生招生简章、重要时间节点、近年录取线（留空位，后期接入）
  - 辅助信息：学校标签（如“工科强校/信息强校/综合类/师范类”）、常见问答
- 后台侧（后续阶段）
  - 学校/学院/学科/专业/标签/简章内容 录入与更新
  - 数据变更的缓存刷新
- 数据范围
  - 先以东南大学 + 若干示例院校为种子数据；后续可批量导入

## 2. 业务流程（V1）
1) 用户进入“学校信息”页
2) 输入关键字/筛选条件（层级、地区、学科标签）检索学校
3) 查看学校详情页：概况 → 强势学科 → 特色专业 → 招生简章
4) 需要时下载/查看原文链接

异常路径：未找到学校/数据缺失 => 返回 `{status: unfit, code: not_found_or_incomplete, message}` 并展示友好提示

## 3. 统一返回规范
- 成功：`{ code: 0, data: ..., message: "ok" }`
- 业务异常：`{ code: 400xx, status: "unfit", message: "原因", details: [...] }`
- 系统异常：`{ code: 500xx, message: "internal error" }`

## 4. 数据库表（MySQL，无外键，以索引与应用层约束为主）
- 学校主体
  - `sch_university(id, name, alias, level, province, city, website, brief, founded_year, created_at, updated_at)`
  - 说明：`level` 取值如 `211/985/双一流/普通本科`，可多值逗号分隔；`brief` 可存 Markdown
- 学院与学科
  - `sch_department(id, university_id, name, brief, created_at, updated_at)`
  - `sch_discipline(id, name, field, parent_id, created_at, updated_at)`  // 学科字典，如 计算机科学 与 上层理工科
  - `sch_univ_discipline_strength(university_id, discipline_id, rank, source, year, note)` // 强势学科（唯一索引：university_id+discipline_id+year）
- 专业与培养
  - `sch_major(id, name, degree, discipline_id, code, brief)` // degree: 本科/硕士/博士
  - `sch_univ_major(university_id, major_id, department_id, feature_tag, note)`
- 标签与映射
  - `sch_tag(id, name, type)` // type: school/department/major
  - `sch_tag_map(tag_id, target_type, target_id)` // 唯一索引：tag_id+target_type+target_id
- 招生简章/资讯
  - `sch_admission_brochure(id, university_id, degree, year, title, content_md, link, created_at, updated_at)`
  - 备注：`content_md` 可选；如体积大可仅存 `link`
- 索引建议
  - `sch_university(name)`、`sch_university(level,province)`
  - `sch_department(university_id)`、`sch_univ_discipline_strength(university_id,discipline_id,year)`
  - `sch_univ_major(university_id,major_id)`、`sch_tag_map(tag_id,target_type)`

一致性与清理约定（与全局约定一致）：
- 写入前应用层校验关联实体存在（如 `university_id`、`discipline_id` 等）
- 删除前执行引用检查，按“映射/子表→主体”的顺序清理

## 5. 接口草案（REST）
- 学校检索与详情
  - GET `/api/school/list?keyword=&level=&province=&page=&size=`
  - GET `/api/school/{id}` → 学校概况 + 标签 + 一句话简介
- 学校下属信息
  - GET `/api/school/{id}/departments`
  - GET `/api/school/{id}/disciplines/strength?year=&topN=`
  - GET `/api/school/{id}/majors?degree=&disciplineId=`
  - GET `/api/school/{id}/brochures?degree=&year=`
- 字典与标签
  - GET `/api/school/dicts/levels` → ["985","211","双一流",...]
  - GET `/api/school/dicts/disciplines?parentId=`
  - GET `/api/school/tags?type=school&keyword=`

分页规则：`page>=0, 1<=size<=100`，非法参数由全局异常处理器统一输出

## 6. DTO（摘要）
- `SchoolBriefDTO`：id、name、level、province、city、tags[]、website
- `SchoolDetailDTO`：上面 + brief、foundedYear
- `DisciplineStrengthDTO`：disciplineId、disciplineName、rank、source、year
- `MajorDTO`：id、name、degree、disciplineId、departmentName、featureTag
- `BrochureDTO`：id、degree、year、title、link

## 7. 流程图（Mermaid）
```mermaid
flowchart TD
  A[进入学校信息页] --> B[输入关键字/筛选检索]
  B --> C[GET /api/school/list]
  C --> D{是否选择学校}
  D -- 否 --> B
  D -- 是 --> E[GET /api/school/{id}]
  E --> F[展示概况/标签]
  F --> G[GET /api/school/{id}/disciplines/strength]
  G --> H[展示强势学科TopN]
  F --> I[GET /api/school/{id}/majors]
  I --> J[展示特色专业]
  F --> K[GET /api/school/{id}/brochures]
  K --> L[展示招生简章/外链]
```

## 13. 字典与标签接口（2025-09-27）
- 学校层级字典
  - GET `/api/school/dicts/levels`
  - 返回：`["985","211","双一流","普通本科"]`
- 学科字典
  - GET `/api/school/dicts/disciplines?parentId=`
  - 规则：
    - 省略 `parentId` → 返回全量
    - `parentId=0` → 返回顶层（`parent_id IS NULL`）
    - 其他数值 → 返回该父节点的子学科
  - 返回元素：`{ id, name, parentId }`
- 标签检索
  - GET `/api/school/tags?type=school&keyword=`
  - `type` 必填：`school|department|major`
  - `keyword` 可选：按名称模糊

curl 示例：
```bash
# 1) 层级字典
curl "http://localhost:8080/api/school/dicts/levels"

# 2) 学科字典（顶层）
curl "http://localhost:8080/api/school/dicts/disciplines?parentId=0"

# 3) 学科字典（子节点）
curl "http://localhost:8080/api/school/dicts/disciplines?parentId=101"

# 4) 标签（按类型全量）
curl "http://localhost:8080/api/school/tags?type=school"

# 5) 标签（按关键词）
curl "http://localhost:8080/api/school/tags?type=school&keyword=工科"
```
## 8. 接口关系图（Mermaid）
```mermaid
graph LR
  L[/GET /api/school/list/]
  S[/GET /api/school/{id}/]
  SD[/GET /api/school/{id}/disciplines/strength/]
  SM[/GET /api/school/{id}/majors/]
  SB[/GET /api/school/{id}/brochures/]
  DL[/GET /api/school/dicts/levels/]
  DD[/GET /api/school/dicts/disciplines/]
  T[/GET /api/school/tags/]
  L --> S
  S --> SD
  S --> SM
  S --> SB
  DL --> L
  DD --> SD
```

## 9. 测试用例清单（curl/JUnit）
- 正常：
  - 学校检索：`/api/school/list?keyword=东南&page=0&size=20` 返回命中记录
  - 学校详情：`/api/school/{id}` 返回概况与标签
  - 强势学科TopN：`/api/school/{id}/disciplines/strength?year=2024&topN=5`
  - 特色专业：`/api/school/{id}/majors?degree=本科`
  - 招生简章：`/api/school/{id}/brochures?degree=本科&year=2024`
- 边界：
  - `keyword` 为空仅用筛选项；`size=1` 与 `size=100` 边界
  - `topN` 缺省回退 5；`year` 缺省取最近年份
- 异常：
  - `id` 不存在 → `status=unfit, code=school_not_found`
  - `page=-1` 或 `size=0/101` → 参数非法（全局异常）

示例 curl 片段：
```bash
curl "http://localhost:8080/api/school/list?keyword=东南&page=0&size=10"

curl "http://localhost:8080/api/school/1"

curl "http://localhost:8080/api/school/1/disciplines/strength?year=2024&topN=5"

curl "http://localhost:8080/api/school/1/majors?degree=本科"

curl "http://localhost:8080/api/school/1/brochures?degree=本科&year=2024"
```

## 10. 种子数据（示例 SQL 片段，可放入 data.sql）
```sql
-- 学校
INSERT INTO sch_university(id, name, alias, level, province, city, website, brief, founded_year)
VALUES (1,'东南大学','SEU','985,211,双一流','江苏','南京','https://www.seu.edu.cn','东南大学，工科见长的综合性研究型大学。',1902)
ON DUPLICATE KEY UPDATE name=VALUES(name), alias=VALUES(alias), level=VALUES(level), province=VALUES(province), city=VALUES(city), website=VALUES(website), brief=VALUES(brief), founded_year=VALUES(founded_year);

-- 学院
INSERT INTO sch_department(id, university_id, name, brief) VALUES
(11,1,'计算机科学与工程学院','信息类核心学院'),
(12,1,'软件学院','软件工程人才培养'),
(13,1,'自动化学院','控制与系统工程')
ON DUPLICATE KEY UPDATE name=VALUES(name), brief=VALUES(brief);

-- 学科字典（节选）
INSERT INTO sch_discipline(id, name, field, parent_id) VALUES
(101,'计算机科学与技术','工学',NULL),
(102,'软件工程','工学',101),
(103,'控制科学与工程','工学',NULL)
ON DUPLICATE KEY UPDATE name=VALUES(name), field=VALUES(field), parent_id=VALUES(parent_id);

-- 强势学科（2024示例）
INSERT INTO sch_univ_discipline_strength(university_id, discipline_id, rank, source, year, note) VALUES
(1,101, A, '第四轮学科评估(示例)', 2024, '示例等级'),
(1,102, A, '第四轮学科评估(示例)', 2024, '示例等级')
ON DUPLICATE KEY UPDATE rank=VALUES(rank), source=VALUES(source), note=VALUES(note);

-- 专业与映射
INSERT INTO sch_major(id, name, degree, discipline_id, code, brief) VALUES
(201,'计算机科学与技术','本科',101,'080901',''),
(202,'软件工程','本科',102,'080902','')
ON DUPLICATE KEY UPDATE name=VALUES(name), degree=VALUES(degree), discipline_id=VALUES(discipline_id), code=VALUES(code), brief=VALUES(brief);

INSERT INTO sch_univ_major(university_id, major_id, department_id, feature_tag, note) VALUES
(1,201,11,'强基计划',''),
(1,202,12,'工程实践强','')
ON DUPLICATE KEY UPDATE feature_tag=VALUES(feature_tag), note=VALUES(note);

-- 标签
INSERT INTO sch_tag(id, name, type) VALUES
(301,'工科强校','school'),(302,'信息强校','school')
ON DUPLICATE KEY UPDATE name=VALUES(name), type=VALUES(type);

INSERT INTO sch_tag_map(tag_id, target_type, target_id) VALUES
(301,'school',1),(302,'school',1)
ON DUPLICATE KEY UPDATE tag_id=VALUES(tag_id);

-- 招生简章（外链）
INSERT INTO sch_admission_brochure(id, university_id, degree, year, title, content_md, link) VALUES
(401,1,'本科',2024,'东南大学2024年本科招生章程',NULL,'https://zsb.seu.edu.cn/xxx'),
(402,1,'硕士',2024,'东南大学2024年硕士招生简章',NULL,'https://yzb.seu.edu.cn/yyy')
ON DUPLICATE KEY UPDATE title=VALUES(title), link=VALUES(link);
```

注意：上文 `rank` 示例为等级（如 A/A+/B+），若使用数值排名请改为 `rank_value INT` 与 `grade VARCHAR` 分列。

## 11. 进度与后续
- 本次输出：接口文档 + 表结构 + 示例种子数据（东南大学）
- 下一步：
  - 建表 SQL（schema.sql）与示例数据（data.sql）落库
  - 实体/Mapper/Service/Controller 骨架（先跑通 GET 列表/详情）
  - JUnit 与 curl 覆盖正常/边界/异常用例
  - 前端页面骨架与 API 封装（后续会话）

## 12. 接口增强（排序与分页，2025-09-27）
- 学科强势：`GET /api/school/{id}/disciplines/strength`
  - 参数新增：`page`、`size`、`sortBy`(grade|rankValue)、`order`(asc|desc)
  - 处理顺序：按 `year` 回退最新年 → 排序 → `topN` 截断 → 分页切片
- 专业列表：`GET /api/school/{id}/majors`
  - 参数新增：`page`、`size`、`sortBy`(name|code[备用])、`order`(asc|desc)
  - 增强：返回 `departmentName`（由 `departmentId` 映射）
- 招生简章：`GET /api/school/{id}/brochures`
  - 参数新增：`page`、`size`
  - 增强：`year` 为空时回退到“最近年份”

curl 示例：
```bash
# 强势学科：按等级升序（默认），TopN 后分页
curl "http://localhost:8080/api/school/1/disciplines/strength?year=2024&topN=5&page=0&size=10&sortBy=grade&order=asc"

# 专业列表：按名称倒序，分页
curl "http://localhost:8080/api/school/1/majors?degree=本科&page=0&size=10&sortBy=name&order=desc"

# 招生简章：year 省略，回退最近年份 + 分页
curl "http://localhost:8080/api/school/1/brochures?page=0&size=10"
```
